<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>オセロ・オンライン＆CPU</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_NiCTmJwDA0nWNISNYaQXNuih6XRGQWE",
            authDomain: "othello-bae8a.firebaseapp.com",
            databaseURL: "https://othello-bae8a-default-rtdb.firebaseio.com",
            projectId: "othello-bae8a",
            storageBucket: "othello-bae8a.firebasestorage.app",
            messagingSenderId: "265645164943",
            appId: "1:265645164943:web:fe9e04fcf3b61cadc723fa",
            measurementId: "G-D28D7RMZFQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let roomRef, myColor, currentRole, isCPU = false;
        let board = Array(8).fill().map(() => Array(8).fill(0));
        let turn = 1;

        // メニュー
        window.startCPUGame = () => {
            isCPU = true;
            myColor = 1; // 黒
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            board = initBoardData();
            turn = 1;
            updateInfo("CPU戦：あなたの番（黒）");
            drawBoard();
        };

        window.showRoomSetup = (role) => {
            isCPU = false;
            currentRole = role;
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('room-setup').classList.remove('hidden');
            document.getElementById('setup-title').innerText = role === 'host' ? '部屋を作る' : '部屋に入る';
        };

        window.handleRoomAction = async () => {
            const rId = document.getElementById('room-id').value;
            const rPass = document.getElementById('room-pass').value;
            if(!rId || !rPass) return alert("入力してね");

            roomRef = ref(db, 'rooms/' + rId);
            const snap = await get(roomRef);
            if (currentRole === 'host') {
                if(snap.exists()) return alert("その部屋名は既にあります");
                myColor = 1;
                await set(roomRef, { password: rPass, board: JSON.stringify(initBoardData()), turn: 1, status: 'waiting' });
            } else {
                if(!snap.exists() || snap.val().password !== rPass) return alert("パスが違うよ");
                myColor = 2;
                await update(roomRef, { status: 'playing' });
            }
            startSync();
        };

        function initBoardData() {
            let b = Array(8).fill().map(() => Array(8).fill(0));
            b[3][3]=2; b[3][4]=1; b[4][3]=1; b[4][4]=2;
            return b;
        }

        function startSync() {
            document.getElementById('room-setup').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            onValue(roomRef, (snap) => {
                const data = snap.val();
                if(!data) return;
                board = JSON.parse(data.board);
                turn = data.turn;
                drawBoard();
                if(data.status === 'waiting') updateInfo("相手の入室待ち...");
                else updateInfo((turn === myColor ? "あなたの番！" : "相手が考え中...") + (myColor === 1 ? "（黒）" : "（白）"));
            });
        }

        function drawBoard() {
            const boardElem = document.getElementById('board');
            boardElem.innerHTML = '';
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.onclick = () => move(r, c);
                    const stone = document.createElement('div');
                    stone.className = 'stone' + (board[r][c]===1?' black':board[r][c]===2?' white':'');
                    cell.appendChild(stone);
                    boardElem.appendChild(cell);
                }
            }
        }

        async function move(r, c) {
            if(turn !== myColor) return;
            if(placeStone(r, c, myColor)) {
                if(isCPU) {
                    turn = 2;
                    updateInfo("CPUが考え中...");
                    drawBoard();
                    setTimeout(cpuLogic, 800);
                } else {
                    await update(roomRef, { board: JSON.stringify(board), turn: 3 - myColor });
                }
            }
        }

        function cpuLogic() {
            let moves = [];
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    if(canPlace(r, c, 2)) moves.push({r, c});
                }
            }
            if(moves.length > 0) {
                // 角を取れるなら取る、なければランダム
                const corners = moves.filter(m => (m.r===0||m.r===7) && (m.c===0||m.c===7));
                const target = corners.length > 0 ? corners[0] : moves[Math.floor(Math.random() * moves.length)];
                placeStone(target.r, target.c, 2);
            }
            turn = 1;
            if(!canPlayerMove(1)) { // プレイヤーが打てないならCPUが連打
                if(canPlayerMove(2)) setTimeout(cpuLogic, 800);
                else alert("対局終了！");
            }
            updateInfo("あなたの番（黒）");
            drawBoard();
        }

        function canPlace(r, c, color) {
            if(board[r][c] !== 0) return false;
            let found = false;
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            dirs.forEach(([dr, dc]) => {
                let nr = r + dr, nc = c + dc, count = 0;
                while(nr>=0 && nr<8 && nc>=0 && nc<8 && board[nr][nc] === 3-color) { nr+=dr; nc+=dc; count++; }
                if(count>0 && nr>=0 && nr<8 && nc>=0 && nc<8 && board[nr][nc] === color) found = true;
            });
            return found;
        }

        function canPlayerMove(color) {
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(canPlace(r, c, color)) return true;
            return false;
        }

        function placeStone(r, c, color) {
            if(!canPlace(r, c, color)) return false;
            const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
            dirs.forEach(([dr, dc]) => {
                let nr = r + dr, nc = c + dc, path = [];
                while(nr>=0 && nr<8 && nc>=0 && nc<8 && board[nr][nc] === 3-color) {
                    path.push({r:nr, c:nc}); nr+=dr; nc+=dc;
                }
                if(path.length>0 && nr>=0 && nr<8 && nc>=0 && nc<8 && board[nr][nc] === color) {
                    path.forEach(p => board[p.r][p.c] = color);
                }
            });
            board[r][c] = color;
            return true;
        }

        function updateInfo(txt) { document.getElementById('info').innerText = txt; }
    </script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #cfd8dc; }
        #menu, #room-setup, #game-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 30px; text-align: center; width: 340px; }
        .hidden { display: none; }
        #board { display: grid; grid-template-columns: repeat(8, 40px); grid-template-rows: repeat(8, 40px); background: #2e7d32; border: 4px solid #1b5e20; margin: 0 auto; }
        .cell { width: 40px; height: 40px; border: 0.5px solid rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .stone { width: 34px; height: 34px; border-radius: 50%; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .black { display: block; background: #000; }
        .white { display: block; background: #fff; }
        button { padding: 12px; margin: 8px; width: 80%; cursor: pointer; background: #2e7d32; color: white; border: none; border-radius: 8px; font-weight: bold; }
        #info { margin-bottom: 15px; font-weight: bold; color: #1b5e20; }
    </style>
</head>
<body>
    <div id="menu">
        <h1 style="color:#1b5e20">Othello Online</h1>
        <button onclick="startCPUGame()">CPUと対戦 (1人)</button>
        <button onclick="showRoomSetup('host')">部屋を作る (2人)</button>
        <button onclick="showRoomSetup('guest')">部屋に入る (2人)</button>
    </div>
    <div id="room-setup" class="hidden">
        <h2 id="setup-title">部屋設定</h2>
        <input type="text" id="room-id" placeholder="部屋名" style="padding:10px; width:80%; margin:5px;"><br>
        <input type="password" id="room-pass" placeholder="合言葉" style="padding:10px; width:80%; margin:5px;"><br>
        <button onclick="handleRoomAction()">対戦開始</button>
        <button onclick="location.reload()" style="background:#888">戻る</button>
    </div>
    <div id="game-container" class="hidden">
        <div id="info"></div>
        <div id="board"></div>
        <button onclick="location.reload()" style="background:#888; margin-top:20px; width:auto;">終了して戻る</button>
    </div>
</body>
</html>
